<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chennai Traffic Control Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
        .transition-colors { transition-property: background-color, border-color, color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        
        .bg-gray-900 { background-color: #111827; }
        .bg-gray-800 { background-color: #1f2937; }
        .bg-gray-700 { background-color: #374151; }
        .bg-gray-600 { background-color: #4b5563; }
        .text-white { color: #ffffff; }
        .text-gray-300 { color: #d1d5db; }
        .text-gray-400 { color: #9ca3af; }
        .border-gray-700 { border-color: #374151; }
        .border-gray-600 { border-color: #4b5563; }
        
        .ring-4 { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5); }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .street-pattern {
            background-image: 
                linear-gradient(rgba(75, 85, 99, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(75, 85, 99, 0.3) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #475569 0%, #334155 50%, #1e293b 100%);
        }
        
        /* Map container styling */
        #map-container {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Custom marker styling */
        .junction-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .junction-marker.selected {
            transform: scale(1.4);
            z-index: 1000;
            box-shadow: 0 0 0 3px #3b82f6, 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        .junction-marker.low { background-color: #10b981; }
        .junction-marker.medium { background-color: #f59e0b; }
        .junction-marker.high { background-color: #ef4444; }
        .junction-marker.emergency { 
            background-color: #dc2626; 
            animation: pulse 1s infinite;
        }
        
        /* Custom popup styling */
        .leaflet-popup-content-wrapper {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        
        .leaflet-popup-tip {
            background: #1f2937;
        }
        
        .leaflet-popup-content {
            margin: 12px 15px;
            line-height: 1.4;
        }
        
        .popup-content {
            min-width: 200px;
        }
        
        .popup-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #3b82f6;
        }
        
        .popup-detail {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 13px;
        }
        
        .popup-label {
            color: #9ca3af;
        }
        
        .popup-value {
            color: #f9fafb;
            font-weight: 500;
        }
        
        .popup-phase {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #374151;
        }
        
        /* Traffic flow indicators */
        .traffic-indicators {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .traffic-indicator {
            width: 8px;
            height: 32px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }
        
        .traffic-indicator:nth-child(2) {
            animation-delay: 0.5s;
        }
        
        .traffic-indicator:nth-child(3) {
            animation-delay: 1s;
        }
        
        /* Traffic signal visualization */
        .traffic-signal {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding: 5px;
            background: #2d3748;
            border-radius: 5px;
        }
        
        .signal-direction {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .signal-direction-label {
            font-size: 10px;
            margin-bottom: 5px;
            color: #cbd5e0;
        }
        
        .signal-lights {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .signal-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .signal-light.active {
            opacity: 1;
            box-shadow: 0 0 5px currentColor;
        }
        
        .signal-light.red { background-color: #ef4444; }
        .signal-light.yellow { background-color: #f59e0b; }
        .signal-light.green { background-color: #10b981; }
        
        /* Camera feed styling */
        .camera-feed {
            width: 100%;
            height: 160px;
            background: #000;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .camera-feed img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a202c;
            color: #718096;
        }
        
        /* Button states */
        .btn-accepted {
            background-color: #10b981 !important;
            cursor: not-allowed !important;
        }
        
        .btn-declined {
            background-color: #6b7280 !important;
            cursor: not-allowed !important;
        }
        
        .btn-resolved {
            background-color: #10b981 !important;
            cursor: not-allowed !important;
        }
        
        .opencv-feed { 
            border: 2px solid #3b82f6; 
        }
    </style>
</head>
<body class="h-screen bg-gray-900 text-white">
    <div id="dashboard" class="h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-700">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-blue-400">Chennai Traffic Control</h1>
                <div id="current-time" class="text-sm text-gray-300"></div>
            </div>
            <div class="flex items-center space-x-6">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-sm">System Online</span>
                </div>
                <div class="text-sm">
                    Active Incidents: <span id="incident-count" class="text-red-400 font-bold">3</span>
                </div>
                <div class="text-sm">
                    AI Traffic Reduction: <span id="traffic-reduction" class="text-green-400 font-bold">0%</span>
                </div>
                <button id="emergency-toggle" class="px-4 py-2 rounded font-medium bg-gray-600 text-gray-300 hover:bg-gray-500 transition-colors">
                    Emergency Mode OFF
                </button>
            </div>
        </div>

        <div class="flex-1 flex">
            <!-- Left Panel -->
            <div class="w-1/4 bg-gray-800 p-4 space-y-4 overflow-y-auto">
                <!-- OpenCV Camera Feed -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">Live OpenCV Analysis</h3>
                    <div class="camera-feed opencv-feed">
                        <img id="video-feed" src="{{ url_for('video_feed') }}" alt="OpenCV Vehicle Detection">
                    </div>
                    <div class="text-xs text-gray-400 mt-1">Real-time YOLO Vehicle Detection & Tracking</div>
                </div>

                <!-- Junction Selector -->
                <div>
                    <h3 class="text-sm font-semibold mb-2 text-gray-300">Selected Junction</h3>
                    <select id="junction-selector" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <option value="anna-salai-mount">Anna Salai - Mount Road</option>
                        <option value="omr-sholinganallur">OMR - Sholinganallur</option>
                        <option value="ecr-mahabalipuram">ECR - Mahabalipuram Rd</option>
                    </select>
                </div>

                <!-- Live Metrics -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">Live Metrics</h3>
                    <div class="space-y-3" id="metrics-panel">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Incident Feed -->
                <div class="bg-gray-700 p-3 rounded flex-1">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">Live Incidents</h3>
                    <div class="space-y-2" id="incidents-feed">
                        <!-- Incidents will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Center - Map View -->
            <div class="flex-1 bg-gray-700 relative">
                <div class="absolute top-4 left-4 bg-gray-800 p-2 rounded z-10">
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Chennai Traffic Map</h3>
                    <p class="text-xs text-gray-400">Real-time junction monitoring</p>
                </div>
                
                <!-- Map Container -->
                <div id="map-container"></div>
                
                <!-- Traffic flow indicators -->
                <div class="traffic-indicators">
                    <div class="traffic-indicator bg-green-400"></div>
                    <div class="traffic-indicator bg-yellow-400"></div>
                    <div class="traffic-indicator bg-red-400"></div>
                </div>
                
                <!-- Legend -->
                <div class="absolute bottom-4 left-20 bg-gray-800 bg-opacity-90 p-3 rounded shadow-lg z-10">
                    <h4 class="text-xs font-semibold mb-2 text-white">Traffic Density</h4>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                            <span class="text-gray-300">Low (0-40%)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                            <span class="text-gray-300">Medium (40-70%)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                            <span class="text-gray-300">High (70%+)</span>
                        </div>
                        <div class="flex items-center space-x-2 mt-2 pt-1 border-t border-gray-600">
                            <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="text-gray-300">Emergency</span>
                        </div>
                    </div>
                </div>

                <!-- Map attribution -->
                <div class="absolute bottom-4 right-4 text-xs text-gray-400 bg-gray-800 bg-opacity-80 px-2 py-1 rounded z-10">
                    Â© OpenStreetMap contributors
                </div>
            </div>

            <!-- Right Panel -->
            <div class="w-1/4 bg-gray-800 p-4 space-y-4 overflow-y-auto">
                <!-- Live Camera Feed -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">Junction Camera</h3>
                    <div id="camera-feed-container">
                        <div class="camera-placeholder">
                            <span>Junction View</span>
                        </div>
                    </div>
                </div>

                <!-- AI Recommendations -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">AI Recommendations</h3>
                    <div class="space-y-3" id="ai-recommendations">
                        <!-- AI recommendations will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Signal Controls -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">Signal Control</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">Manual Override</span>
                            <button id="manual-override" class="px-3 py-1 rounded text-xs font-medium bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                                Override OFF
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-3" id="signal-controls">
                            <!-- Signal control buttons will be populated by JavaScript -->
                        </div>
                        
                        <div class="mt-3">
                            <button id="emergency-preemption" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white p-2 rounded text-xs font-medium transition-colors">
                                Emergency Preemption
                            </button>
                        </div>
                    </div>
                </div>

                <!-- System Health -->
                <div class="bg-gray-700 p-3 rounded">
                    <h3 class="text-sm font-semibold mb-3 text-gray-300">System Health</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">OpenCV Cameras</span>
                            <div class="flex items-center space-x-1">
                                <div id="camera-status-indicator" class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                                <span id="camera-status" class="text-xs text-yellow-400">Initializing...</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">YOLO Detection</span>
                            <div class="flex items-center space-x-1">
                                <div id="yolo-status-indicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span id="yolo-status" class="text-xs text-green-400">Loading...</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">Frame Rate</span>
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span id="frame-rate" class="text-xs text-green-400">0 FPS</span>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">Traffic Processing</span>
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                                <span class="text-xs text-green-400">Active</span>
                            </div>
                        </div>
                        
                        <div id="camera-help" class="mt-2 p-2 bg-blue-900 rounded border border-blue-700 hidden">
                            <p class="text-xs text-blue-200">ðŸ’¡ Camera not detected. Using simulated traffic data.</p>
                            <p class="text-xs text-blue-300">Connect a webcam for live video processing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Detail Modal -->
    <div id="incident-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div id="modal-content">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>